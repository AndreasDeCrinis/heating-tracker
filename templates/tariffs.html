{% extends "base.html" %}

{% block content %}
<div class="card">
  <h2>Add / update tariff</h2>
  <form method="post">
    <input type="hidden" name="action" value="tariff">
    <div class="grid">
      <div>
        <label for="year">Year</label>
        <input type="number" id="year" name="year" required>
      </div>
      <div>
        <label for="base_price_per_kw">Base price (€/kW/year)</label>
        <input type="number" step="0.0001" id="base_price_per_kw" name="base_price_per_kw" required>
      </div>
      <div>
        <label for="contracted_power_kw">Default power (kW)</label>
        <input type="number" step="0.01" id="contracted_power_kw" name="contracted_power_kw">
      </div>
      <div>
        <label for="working_price_per_kwh">Working price (€/kWh)</label>
        <input type="number" step="0.0001" id="working_price_per_kwh" name="working_price_per_kwh" required>
      </div>
      <div>
        <label for="additional_yearly_costs">Additional yearly costs (€)</label>
        <input type="number" step="0.01" id="additional_yearly_costs" name="additional_yearly_costs" required>
      </div>
    </div>
    <div style="margin-top:0.8rem;">
      <button type="submit">Save tariff</button>
    </div>
  </form>
  <p style="margin-top:0.6rem;font-size:0.8rem;color:#6b7280;">
    Base price is multiplied by the active grid connection power (kW) for each day.
  </p>
</div>

<div class="card">
  <h2>Tariffs per year</h2>
  {% if tariffs %}
    <table>
      <thead>
      <tr>
        <th>Year</th>
        <th>Base €/kW</th>
        <th>Default power kW</th>
        <th>Work €/kWh</th>
        <th>Additional €/year</th>
        <th>Default fixed €/year</th>
      </tr>
      </thead>
      <tbody>
      {% for t in tariffs %}
        <tr>
          <td>{{ t.year }}</td>
          <td>{{ t.base_price_per_kw }}</td>
          <td>{{ t.contracted_power_kw }}</td>
          <td>{{ t.working_price_per_kwh }}</td>
          <td>{{ t.additional_yearly_costs }}</td>
          <td>
            {{ (t.base_price_per_kw * t.contracted_power_kw + t.additional_yearly_costs)|round(2) }}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No tariffs defined yet.</p>
  {% endif %}
</div>

<div class="card">
  <h2>Grid connection power (kW over time)</h2>
  <form method="post">
    <input type="hidden" name="action" value="grid_power">
    <div class="grid">
      <div>
        <label for="gp_date">Valid from (date)</label>
        <input type="date" id="gp_date" name="gp_date" value="{{ today }}" required>
      </div>
      <div>
        <label for="gp_power">Power (kW)</label>
        <input type="number" step="0.1" id="gp_power" name="gp_power" required>
      </div>
    </div>
    <div style="margin-top:0.8rem;">
      <button type="submit">Save grid power</button>
    </div>
  </form>
  <p style="margin-top:0.6rem;font-size:0.8rem;color:#6b7280;">
    Example for your case:<br>
    – 2020-01-01 → 14 kW (or any date before your first reading)<br>
    – 2025-10-01 → 10 kW<br>
    The app will use 14 kW before 1 Oct 2025 and 10 kW from that date onward.
  </p>

  {% if grid_powers %}
    <h3 style="font-size:0.95rem;margin-top:0.9rem;">Defined grid power changes</h3>
    <table>
      <thead>
      <tr>
        <th>Valid from</th>
        <th>Power (kW)</th>
      </tr>
      </thead>
      <tbody>
      {% for gp in grid_powers %}
        <tr>
          <td>{{ gp.date.isoformat() }}</td>
          <td>{{ gp.power_kw }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No grid power changes defined yet. The app will fall back to the tariff's default kW.</p>
  {% endif %}
</div>
{% endblock %}
