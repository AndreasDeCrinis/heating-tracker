{% extends "base.html" %}

{% block content %}
<div class="card">
  <h2>Add meter reading</h2>
  <form method="post">
    <input type="hidden" name="action" value="reading">
    <div class="grid">
      <div>
        <label for="date">Date</label>
        <input type="date" id="date" name="date" value="{{ today }}">
      </div>
      <div>
        <label for="meter_reading">Meter reading (kWh)</label>
        <input type="number" step="0.01" id="meter_reading" name="meter_reading" required>
      </div>
    </div>
    <div style="margin-top: 0.8rem;">
      <button type="submit">Save reading</button>
    </div>
  </form>
  <p style="margin-top:0.6rem;font-size:0.8rem;color:#6b7280;">
    Tip: you can also enter older readings by picking a different date.
  </p>
</div>

<div class="card">
  <h2>Add offset (for meter replacement)</h2>
  <form method="post">
    <input type="hidden" name="action" value="offset">
    <div class="grid">
      <div>
        <label for="offset_date">Date from which this offset applies</label>
        <input type="date" id="offset_date" name="offset_date" value="{{ today }}" required>
      </div>
      <div>
        <label for="offset_kwh">Offset (kWh)</label>
        <input type="number" step="0.01" id="offset_kwh" name="offset_kwh" required>
      </div>
    </div>
    <div style="margin-top:0.8rem;">
      <button type="submit">Save offset</button>
    </div>
  </form>
  <p style="margin-top:0.6rem;font-size:0.8rem;color:#6b7280;">
    Example: if your old meter stopped at 12 000 kWh and the new meter starts at 0,
    add an offset of 12000 kWh for the date the new meter started. All new readings
    will be shifted by this value so the curve stays continuous.
  </p>

  {% if offsets %}
    <h3 style="font-size:0.95rem;margin-top:0.9rem;">Existing offsets</h3>
    <table>
      <thead>
      <tr>
        <th>Date</th>
        <th>Offset kWh</th>
      </tr>
      </thead>
      <tbody>
      {% for o in offsets %}
        <tr>
          <td>{{ o.date.isoformat() }}</td>
          <td>{{ o.offset_kwh }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>

<div class="grid">
  <div class="card">
    <h2>Summary</h2>
    <div class="stat-row">
      <div class="stat">
        <div class="stat-label">All-time avg usage</div>
        <div class="stat-value">
          {% if stats.all_time_avg_kwh_per_day %}
            {{ stats.all_time_avg_kwh_per_day|round(2) }} kWh/day
          {% else %}
            –
          {% endif %}
        </div>
      </div>
      <div class="stat">
        <div class="stat-label">All-time avg cost</div>
        <div class="stat-value">
          {% if stats.all_time_avg_cost_per_day %}
            {{ stats.all_time_avg_cost_per_day|round(2) }} €/day
          {% else %}
            –
          {% endif %}
        </div>
      </div>
      <div class="stat">
        <div class="stat-label">Entries with usage</div>
        <div class="stat-value">{{ stats.daily_entries|length }}</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Last readings</h2>
    {% if readings %}
      <table>
        <thead>
        <tr>
          <th>Date</th>
          <th>Meter (kWh)</th>
        </tr>
        </thead>
        <tbody>
        {% for r in readings|reverse %}
          <tr>
            <td>{{ r.date.isoformat() }}</td>
            <td>{{ "%.1f"|format(r.meter_reading) }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      <p style="font-size:0.75rem;color:#6b7280;margin-top:0.3rem;">
        Only the last 20 entries are shown here.
      </p>
    {% else %}
      <p>No readings yet. Add your first reading above.</p>
    {% endif %}
  </div>
</div>

<div class="card">
  <h2>Daily usage (kWh/day)</h2>
  {% if daily_labels %}
    <div class="chart-wrapper">
      <canvas id="dailyChart"></canvas>
    </div>
  {% else %}
    <p>Need at least two readings to show daily usage.</p>
  {% endif %}
</div>

<div class="card">
  <h2>Average usage per month (kWh/day)</h2>
  {% if monthly_labels %}
    <div class="chart-wrapper">
      <canvas id="monthlyChart"></canvas>
    </div>
    <table style="margin-top:0.8rem;">
      <thead>
      <tr>
        <th>Month</th>
        <th>Avg kWh/day</th>
        <th>Avg cost/day</th>
      </tr>
      </thead>
      <tbody>
      {% for m in stats.monthly_stats %}
        <tr>
          <td>{{ m.month }}</td>
          <td>{{ m.avg_kwh_per_day|round(2) }}</td>
          <td>
            {% if m.avg_cost_per_day %}
              {{ m.avg_cost_per_day|round(2) }} €
            {% else %}
              –
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No monthly data yet.</p>
  {% endif %}
</div>

<script>
  {% if daily_labels %}
  const dailyCtx = document.getElementById('dailyChart').getContext('2d');
  new Chart(dailyCtx, {
    type: 'line',
    data: {
      labels: {{ daily_labels|tojson }},
      datasets: [{
        label: 'kWh/day',
        data: {{ daily_values|tojson }},
        tension: 0.25,
        fill: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          ticks: { maxRotation: 60, minRotation: 30 }
        }
      }
    }
  });
  {% endif %}

  {% if monthly_labels %}
  const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
  new Chart(monthlyCtx, {
    type: 'bar',
    data: {
      labels: {{ monthly_labels|tojson }},
      datasets: [{
        label: 'Avg kWh/day',
        data: {{ monthly_values|tojson }},
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { maxRotation: 60, minRotation: 30 } }
      }
    }
  });
  {% endif %}
</script>
{% endblock %}
